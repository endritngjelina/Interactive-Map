<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPro - Interactive Mapping Suite</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/3.6.2/maplibre-gl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .header {
            padding: 20px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .toggle-sidebar {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .toggle-sidebar:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .controls {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
        }

        .control-group h3 {
            color: #374151;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group h3 i {
            color: #6366f1;
        }

        .btn {
            width: 100%;
            padding: 12px 16px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn.danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .overlay-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            min-width: 200px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .coordinates {
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .distance-result {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
            color: #1e40af;
        }

        .search-container {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-result {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .search-result:hover {
            background: #f9fafb;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            color: #374151;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 1000;
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .map-overlay {
                top: 10px;
                right: 10px;
            }
        }

        .feature-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .feature-item {
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .feature-item button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .legend {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            min-width: 200px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #374151;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            font-size: 12px;
            color: #6b7280;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="header">
                <h1>MapPro</h1>
                <p>Professional Mapping Suite</p>
                <button class="toggle-sidebar" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h3><i class="fas fa-location-dot"></i> Location Services</h3>
                    <button class="btn" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow"></i> Get Current Location
                    </button>
                    <div class="input-group">
                        <label>Search Location</label>
                        <div class="search-container">
                            <input type="text" id="searchInput" placeholder="Enter address or place name...">
                            <div class="search-results" id="searchResults"></div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-map-pin"></i> Markers & Pins</h3>
                    <button class="btn" id="addMarkerBtn" onclick="toggleMarkerMode()">
                        <i class="fas fa-map-pin"></i> Add Custom Marker
                    </button>
                    <div class="input-group">
                        <label>Marker Color</label>
                        <select id="markerColor">
                            <option value="#ff0000">Red</option>
                            <option value="#00ff00">Green</option>
                            <option value="#0000ff">Blue</option>
                            <option value="#ffff00">Yellow</option>
                            <option value="#ff00ff">Magenta</option>
                            <option value="#00ffff">Cyan</option>
                        </select>
                    </div>
                    <button class="btn danger" onclick="clearMarkers()">
                        <i class="fas fa-trash"></i> Clear All Markers
                    </button>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-route"></i> Drawing Tools</h3>
                    <button class="btn" id="drawRouteBtn" onclick="toggleDrawMode()">
                        <i class="fas fa-route"></i> Draw Route
                    </button>
                    <button class="btn" id="measureBtn" onclick="toggleMeasureMode()">
                        <i class="fas fa-ruler"></i> Measure Distance
                    </button>
                    <div id="distanceResult" class="distance-result" style="display: none;"></div>
                    <button class="btn danger" onclick="clearDrawings()">
                        <i class="fas fa-eraser"></i> Clear All Drawings
                    </button>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-fire"></i> Heatmap</h3>
                    <button class="btn" onclick="generateHeatmap()">
                        <i class="fas fa-chart-area"></i> Generate Sample Heatmap
                    </button>
                    <div class="input-group">
                        <label>Heatmap Intensity</label>
                        <input type="range" id="heatmapIntensity" min="0.1" max="1" step="0.1" value="0.5">
                    </div>
                    <button class="btn danger" onclick="clearHeatmap()">
                        <i class="fas fa-times"></i> Clear Heatmap
                    </button>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-layer-group"></i> Map Layers</h3>
                    <button class="btn" onclick="toggleMapStyle()">
                        <i class="fas fa-palette"></i> Toggle Map Style
                    </button>
                    <button class="btn" onclick="toggle3D()">
                        <i class="fas fa-cube"></i> Toggle 3D Buildings
                    </button>
                    <button class="btn" onclick="toggleSatellite()">
                        <i class="fas fa-satellite"></i> Satellite View
                    </button>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-download"></i> Export & Data</h3>
                    <button class="btn" onclick="exportMap()">
                        <i class="fas fa-camera"></i> Export Map Image
                    </button>
                    <button class="btn" onclick="exportData()">
                        <i class="fas fa-file-export"></i> Export GeoJSON
                    </button>
                    <button class="btn" onclick="importData()">
                        <i class="fas fa-file-import"></i> Import GeoJSON
                    </button>
                    <input type="file" id="fileInput" style="display: none;" accept=".json,.geojson">
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <div class="map-overlay">
                <div class="overlay-panel">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>System Online</span>
                    </div>
                    <div class="coordinates" id="coordinates">
                        Lat: 0.0000, Lng: 0.0000
                    </div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                        <span id="zoomLevel">Zoom: 1</span>
                    </div>
                </div>
            </div>

            <div class="legend" id="legend" style="display: none;">
                <h4>Legend</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff0000;"></div>
                    <span>Custom Markers</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #0000ff;"></div>
                    <span>Route Points</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff00;"></div>
                    <span>Current Location</span>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/3.6.2/maplibre-gl.min.js"></script>
    <script>
        // Application State
        let map;
        let markers = [];
        let routes = [];
        let measurePoints = [];
        let heatmapData = [];
        let currentMode = 'normal';
        let currentStyle = 'streets';
        let buildings3D = false;
        let satelliteView = false;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            registerServiceWorker();
            showNotification('MapPro initialized successfully!', 'success');
        });

        function initializeMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://demotiles.maplibre.org/style.json',
                center: [-74.5, 40], // NYC area
                zoom: 9,
                pitch: 0,
                bearing: 0,
                antialias: true
            });

            // Add controls
            map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
            map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
            map.addControl(new maplibregl.FullscreenControl(), 'top-right');

            // Map event listeners
            map.on('load', function() {
                add3DBuildings();
                setupHeatmapSource();
                document.getElementById('legend').style.display = 'block';
            });

            map.on('mousemove', function(e) {
                const coordinates = `Lat: ${e.lngLat.lat.toFixed(4)}, Lng: ${e.lngLat.lng.toFixed(4)}`;
                document.getElementById('coordinates').textContent = coordinates;
            });

            map.on('zoom', function() {
                document.getElementById('zoomLevel').textContent = `Zoom: ${map.getZoom().toFixed(1)}`;
            });

            map.on('click', function(e) {
                handleMapClick(e);
            });

            // Add geolocate control
            const geolocate = new maplibregl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            });
            map.addControl(geolocate, 'top-right');
        }

        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(performSearch, 300));
            
            // File input for import
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            
            // Heatmap intensity slider
            document.getElementById('heatmapIntensity').addEventListener('input', updateHeatmapIntensity);
        }

        function handleMapClick(e) {
            const lngLat = e.lngLat;
            
            switch(currentMode) {
                case 'marker':
                    addMarker(lngLat);
                    break;
                case 'route':
                    addRoutePoint(lngLat);
                    break;
                case 'measure':
                    addMeasurePoint(lngLat);
                    break;
                default:
                    showLocationPopup(lngLat);
            }
        }

        function addMarker(lngLat) {
            const color = document.getElementById('markerColor').value;
            
            const popup = new maplibregl.Popup()
                .setHTML(`
                    <div style="padding: 10px;">
                        <h4>Custom Marker</h4>
                        <p>Lat: ${lngLat.lat.toFixed(4)}</p>
                        <p>Lng: ${lngLat.lng.toFixed(4)}</p>
                        <button onclick="removeMarker(${markers.length})" style="margin-top: 5px; padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                `);

            const marker = new maplibregl.Marker({ color: color })
                .setLngLat(lngLat)
                .setPopup(popup)
                .addTo(map);

            markers.push(marker);
            showNotification(`Marker added at ${lngLat.lat.toFixed(4)}, ${lngLat.lng.toFixed(4)}`, 'success');
        }

        function removeMarker(index) {
            if (markers[index]) {
                markers[index].remove();
                markers.splice(index, 1);
                showNotification('Marker removed', 'info');
            }
        }

        function addRoutePoint(lngLat) {
            const routePoint = {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [lngLat.lng, lngLat.lat]
                }
            };

            // Add route point marker
            const marker = new maplibregl.Marker({ color: '#0000ff' })
                .setLngLat(lngLat)
                .addTo(map);

            routes.push({ marker, point: routePoint });

            if (routes.length > 1) {
                drawRoute();
            }

            showNotification(`Route point ${routes.length} added`, 'success');
        }

        function drawRoute() {
            if (routes.length < 2) return;

            const coordinates = routes.map(r => r.point.geometry.coordinates);
            
            const routeGeoJSON = {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: coordinates
                }
            };

            if (map.getSource('route')) {
                map.getSource('route').setData(routeGeoJSON);
            } else {
                map.addSource('route', {
                    type: 'geojson',
                    data: routeGeoJSON
                });

                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#3b82f6',
                        'line-width': 4,
                        'line-opacity': 0.8
                    }
                });
            }
        }

        function addMeasurePoint(lngLat) {
            const marker = new maplibregl.Marker({ color: '#fbbf24' })
                .setLngLat(lngLat)
                .addTo(map);

            measurePoints.push({ marker, lngLat });

            if (measurePoints.length === 2) {
                const distance = calculateDistance(
                    measurePoints[0].lngLat,
                    measurePoints[1].lngLat
                );
                
                displayDistance(distance);
                drawMeasureLine();
            } else if (measurePoints.length > 2) {
                clearMeasurement();
                addMeasurePoint(lngLat);
            }
        }

        function calculateDistance(point1, point2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLon = (point2.lng - point1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function displayDistance(distance) {
            const resultDiv = document.getElementById('distanceResult');
            resultDiv.innerHTML = `
                <strong>Distance:</strong><br>
                ${distance.toFixed(2)} km<br>
                ${(distance * 0.621371).toFixed(2)} miles
            `;
            resultDiv.style.display = 'block';
        }

        function drawMeasureLine() {
            if (measurePoints.length !== 2) return;

            const lineGeoJSON = {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: [
                        [measurePoints[0].lngLat.lng, measurePoints[0].lngLat.lat],
                        [measurePoints[1].lngLat.lng, measurePoints[1].lngLat.lat]
                    ]
                }
            };

            if (map.getSource('measure-line')) {
                map.getSource('measure-line').setData(lineGeoJSON);
            } else {
                map.addSource('measure-line', {
                    type: 'geojson',
                    data: lineGeoJSON
                });

                map.addLayer({
                    id: 'measure-line',
                    type: 'line',
                    source: 'measure-line',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#fbbf24',
                        'line-width': 3,
                        'line-dasharray': [2, 2]
                    }
                });
            }
        }

        function generateHeatmap() {
            // Generate sample heatmap data
            heatmapData = [];
            const center = map.getCenter();
            
            for (let i = 0; i < 100; i++) {
                const lat = center.lat + (Math.random() - 0.5) * 0.1;
                const lng = center.lng + (Math.random() - 0.5) * 0.1;
                const intensity = Math.random();
                
                heatmapData.push({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [lng, lat]
                    },
                    properties: {
                        intensity: intensity
                    }
                });
            }

            updateHeatmapLayer();
            showNotification('Heatmap generated with 100 sample points', 'success');
        }

        function setupHeatmapSource() {
            map.addSource('heatmap', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });
        }

        function updateHeatmapLayer() {
            const intensity = document.getElementById('heatmapIntensity').value;
            
            if (map.getSource('heatmap')) {
                map.getSource('heatmap').setData({
                    type: 'FeatureCollection',
                    features: heatmapData
                });
            }

            if (!map.getLayer('heatmap-layer')) {
                map.addLayer({
                    id: 'heatmap-layer',
                    type: 'heatmap',
                    source: 'heatmap',
                    maxzoom: 15,
                    paint: {
                        'heatmap-weight': [
                            'interpolate',
                            ['linear'],
                            ['get', 'intensity'],
                            0, 0,
                            1, 1
                        ],
                        'heatmap-intensity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0, parseFloat(intensity),
                            15, parseFloat(intensity) * 2
                        ],
                        'heatmap-color': [
                            'interpolate',
                            ['linear'],
                            ['heatmap-density'],
                            0, 'rgba(33,102,172,0)',
                            0.2, 'rgb(103,169,207)',
                            0.4, 'rgb(209,229,240)',
                            0.6, 'rgb(253,219,199)',
                            0.8, 'rgb(239,138,98)',
                            1, 'rgb(178,24,43)'
                        ],
                        'heatmap-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0, 2,
                            15, 20
                        ],
                        'heatmap-opacity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            7, 1,
                            15, 0.8
                        ]
                    }
                });

                // Add circle layer for individual points at high zoom
                map.addLayer({
                    id: 'heatmap-point',
                    type: 'circle',
                    source: 'heatmap',
                    minzoom: 14,
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['get', 'intensity'],
                            0, 1,
                            1, 8
                        ],
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'intensity'],
                            0, 'rgba(33,102,172,0.8)',
                            1, 'rgba(178,24,43,0.8)'
                        ],
                        'circle-stroke-color': 'white',
                        'circle-stroke-width': 1,
                        'circle-opacity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            14, 0,
                            15, 1
                        ]
                    }
                });
            }
        }

        function updateHeatmapIntensity() {
            if (map.getLayer('heatmap-layer')) {
                const intensity = document.getElementById('heatmapIntensity').value;
                map.setPaintProperty('heatmap-layer', 'heatmap-intensity', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, parseFloat(intensity),
                    15, parseFloat(intensity) * 2
                ]);
            }
        }

        function clearHeatmap() {
            if (map.getLayer('heatmap-layer')) {
                map.removeLayer('heatmap-layer');
            }
            if (map.getLayer('heatmap-point')) {
                map.removeLayer('heatmap-point');
            }
            heatmapData = [];
            showNotification('Heatmap cleared', 'info');
        }

        function add3DBuildings() {
            if (!map.getLayer('3d-buildings')) {
                map.addLayer({
                    id: '3d-buildings',
                    source: 'composite',
                    'source-layer': 'building',
                    filter: ['==', 'extrude', 'true'],
                    type: 'fill-extrusion',
                    minzoom: 15,
                    paint: {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15, 0,
                            15.05, ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15, 0,
                            15.05, ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.6
                    }
                });
            }
        }

        function toggle3D() {
            buildings3D = !buildings3D;
            if (buildings3D) {
                if (map.getLayer('3d-buildings')) {
                    map.setLayoutProperty('3d-buildings', 'visibility', 'visible');
                }
                map.easeTo({ pitch: 45, bearing: -17.6 });
                showNotification('3D Buildings enabled', 'success');
            } else {
                if (map.getLayer('3d-buildings')) {
                    map.setLayoutProperty('3d-buildings', 'visibility', 'none');
                }
                map.easeTo({ pitch: 0, bearing: 0 });
                showNotification('3D Buildings disabled', 'info');
            }
        }

        function toggleMapStyle() {
            const styles = {
                streets: 'https://demotiles.maplibre.org/style.json',
                satellite: 'https://demotiles.maplibre.org/style.json',
                dark: 'https://demotiles.maplibre.org/style.json'
            };
            
            const styleNames = Object.keys(styles);
            const currentIndex = styleNames.indexOf(currentStyle);
            const nextIndex = (currentIndex + 1) % styleNames.length;
            currentStyle = styleNames[nextIndex];
            
            // Store current data
            const currentData = {
                markers: markers,
                routes: routes,
                measurePoints: measurePoints,
                heatmapData: heatmapData
            };
            
            map.setStyle(styles[currentStyle]);
            
            map.once('style.load', () => {
                // Restore data after style change
                setupHeatmapSource();
                if (heatmapData.length > 0) {
                    updateHeatmapLayer();
                }
                add3DBuildings();
            });
            
            showNotification(`Map style changed to ${currentStyle}`, 'success');
        }

        function toggleSatellite() {
            satelliteView = !satelliteView;
            // In a real implementation, you would switch to actual satellite tiles
            showNotification(satelliteView ? 'Satellite view enabled' : 'Street view enabled', 'success');
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by this browser', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Getting location...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const { latitude, longitude } = position.coords;
                    
                    map.flyTo({
                        center: [longitude, latitude],
                        zoom: 15,
                        duration: 2000
                    });

                    // Add current location marker
                    const locationMarker = new maplibregl.Marker({ color: '#00ff00' })
                        .setLngLat([longitude, latitude])
                        .setPopup(
                            new maplibregl.Popup()
                                .setHTML(`
                                    <div style="padding: 10px;">
                                        <h4>Your Location</h4>
                                        <p>Lat: ${latitude.toFixed(4)}</p>
                                        <p>Lng: ${longitude.toFixed(4)}</p>
                                        <p>Accuracy: ${position.coords.accuracy.toFixed(0)}m</p>
                                    </div>
                                `)
                        )
                        .addTo(map);

                    markers.push(locationMarker);
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification('Location found successfully!', 'success');
                },
                function(error) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification('Error getting location: ' + error.message, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 3) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            // Simulate geocoding API call
            // In a real implementation, you would use a geocoding service like Mapbox or OpenStreetMap Nominatim
            const mockResults = [
                { name: `${query} - New York, NY`, lat: 40.7128, lng: -74.0060 },
                { name: `${query} - Los Angeles, CA`, lat: 34.0522, lng: -118.2437 },
                { name: `${query} - Chicago, IL`, lat: 41.8781, lng: -87.6298 }
            ];

            const resultsHtml = mockResults.map(result => `
                <div class="search-result" onclick="selectSearchResult(${result.lat}, ${result.lng}, '${result.name}')">
                    ${result.name}
                </div>
            `).join('');

            document.getElementById('searchResults').innerHTML = resultsHtml;
        }

        function selectSearchResult(lat, lng, name) {
            map.flyTo({
                center: [lng, lat],
                zoom: 14,
                duration: 2000
            });

            const searchMarker = new maplibregl.Marker({ color: '#9333ea' })
                .setLngLat([lng, lat])
                .setPopup(
                    new maplibregl.Popup()
                        .setHTML(`
                            <div style="padding: 10px;">
                                <h4>Search Result</h4>
                                <p>${name}</p>
                                <p>Lat: ${lat.toFixed(4)}</p>
                                <p>Lng: ${lng.toFixed(4)}</p>
                            </div>
                        `)
                )
                .addTo(map);

            markers.push(searchMarker);
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchInput').value = '';
            showNotification(`Found: ${name}`, 'success');
        }

        function showLocationPopup(lngLat) {
            const popup = new maplibregl.Popup()
                .setLngLat(lngLat)
                .setHTML(`
                    <div style="padding: 10px;">
                        <h4>Location Info</h4>
                        <p>Latitude: ${lngLat.lat.toFixed(4)}</p>
                        <p>Longitude: ${lngLat.lng.toFixed(4)}</p>
                        <button onclick="addMarker({lat: ${lngLat.lat}, lng: ${lngLat.lng}})" 
                                style="margin-top: 5px; padding: 5px 10px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Add Marker Here
                        </button>
                    </div>
                `)
                .addTo(map);
        }

        function toggleMarkerMode() {
            const btn = document.getElementById('addMarkerBtn');
            if (currentMode === 'marker') {
                currentMode = 'normal';
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-map-pin"></i> Add Custom Marker';
                showNotification('Marker mode disabled', 'info');
            } else {
                currentMode = 'marker';
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> Cancel Marker Mode';
                showNotification('Click on the map to add markers', 'info');
            }
        }

        function toggleDrawMode() {
            const btn = document.getElementById('drawRouteBtn');
            if (currentMode === 'route') {
                currentMode = 'normal';
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-route"></i> Draw Route';
                showNotification('Route drawing disabled', 'info');
            } else {
                currentMode = 'route';
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> Cancel Route Mode';
                showNotification('Click on the map to add route points', 'info');
            }
        }

        function toggleMeasureMode() {
            const btn = document.getElementById('measureBtn');
            if (currentMode === 'measure') {
                currentMode = 'normal';
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-ruler"></i> Measure Distance';
                showNotification('Measure mode disabled', 'info');
            } else {
                currentMode = 'measure';
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> Cancel Measure Mode';
                showNotification('Click two points on the map to measure distance', 'info');
            }
        }

        function clearMarkers() {
            markers.forEach(marker => marker.remove());
            markers = [];
            showNotification('All markers cleared', 'info');
        }

        function clearDrawings() {
            // Clear routes
            routes.forEach(route => route.marker.remove());
            routes = [];
            if (map.getSource('route')) {
                map.getSource('route').setData({
                    type: 'FeatureCollection',
                    features: []
                });
            }

            // Clear measurements
            clearMeasurement();
            
            showNotification('All drawings cleared', 'info');
        }

        function clearMeasurement() {
            measurePoints.forEach(point => point.marker.remove());
            measurePoints = [];
            document.getElementById('distanceResult').style.display = 'none';
            
            if (map.getSource('measure-line')) {
                map.getSource('measure-line').setData({
                    type: 'FeatureCollection',
                    features: []
                });
            }
        }

        function exportMap() {
            const canvas = map.getCanvas();
            const link = document.createElement('a');
            link.download = 'mapro-export.png';
            link.href = canvas.toDataURL();
            link.click();
            showNotification('Map exported as PNG', 'success');
        }

        function exportData() {
            const geojson = {
                type: 'FeatureCollection',
                features: []
            };

            // Add markers
            markers.forEach((marker, index) => {
                const lngLat = marker.getLngLat();
                geojson.features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [lngLat.lng, lngLat.lat]
                    },
                    properties: {
                        type: 'marker',
                        id: index
                    }
                });
            });

            // Add routes
            if (routes.length > 0) {
                geojson.features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: routes.map(r => r.point.geometry.coordinates)
                    },
                    properties: {
                        type: 'route'
                    }
                });
            }

            // Add heatmap data
            geojson.features.push(...heatmapData);

            const dataStr = JSON.stringify(geojson, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mapro-data.geojson';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Data exported as GeoJSON', 'success');
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const geojson = JSON.parse(e.target.result);
                    loadGeoJSON(geojson);
                    showNotification('Data imported successfully', 'success');
                } catch (error) {
                    showNotification('Error importing data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function loadGeoJSON(geojson) {
            if (geojson.type === 'FeatureCollection') {
                geojson.features.forEach(feature => {
                    if (feature.geometry.type === 'Point') {
                        const [lng, lat] = feature.geometry.coordinates;
                        const marker = new maplibregl.Marker()
                            .setLngLat([lng, lat])
                            .addTo(map);
                        markers.push(marker);
                    }
                });
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.querySelector('.toggle-sidebar i');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                icon.className = 'fas fa-chevron-left';
            } else {
                sidebar.classList.add('collapsed');
                icon.className = 'fas fa-chevron-right';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Service Worker Registration for offline capabilities
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'mapro-cache-v1';
                    const urlsToCache = [
                        '/',
                        'https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/3.6.2/maplibre-gl.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/3.6.2/maplibre-gl.min.css',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('Service Worker registered successfully');
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed');
                    });
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'm':
                        e.preventDefault();
                        toggleMarkerMode();
                        break;
                    case 'r':
                        e.preventDefault();
                        toggleDrawMode();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleMeasureMode();
                        break;
                    case 'l':
                        e.preventDefault();
                        getCurrentLocation();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportMap();
                        break;
                }
            }
        });

        // Touch gestures for mobile
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 50) {
                    // Swipe left - hide sidebar
                    document.getElementById('sidebar').classList.add('collapsed');
                } else if (diffX < -50) {
                    // Swipe right - show sidebar
                    document.getElementById('sidebar').classList.remove('collapsed');
                }
            }
        });

        // Performance monitoring
        const performanceObserver = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            entries.forEach((entry) => {
                if (entry.entryType === 'navigation') {
                    console.log('Page load time:', entry.loadEventEnd - entry.loadEventStart);
                }
            });
        });

        if (typeof PerformanceObserver !== 'undefined') {
            performanceObserver.observe({ entryTypes: ['navigation', 'resource'] });
        }

        // Error handling
        window.addEventListener('error', function(e) {
            showNotification('An error occurred: ' + e.message, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            showNotification('Promise rejection: ' + e.reason, 'error');
        });
    </script>
</body>
</html>